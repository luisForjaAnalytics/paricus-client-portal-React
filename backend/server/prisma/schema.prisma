generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Client {
  id                     Int                        @id @default(autoincrement())
  name                   String
  isActive               Boolean                    @default(true) @map("is_active")
  isProspect             Boolean                    @default(false) @map("is_prospect")
  createdAt              DateTime                   @default(now()) @map("created_at")
  updatedAt              DateTime                   @default(now()) @updatedAt @map("updated_at")
  reports                Report[]
  roles                  Role[]
  users                  User[]
  knowledgeBase          KnowledgeBase[]
  folderAccess           ClientFolderAccess[]
  invoices               Invoice[]
  tickets                Ticket[]
  announcementRecipients AnnouncementRecipient[]

  @@index([isActive])
  @@index([isProspect])
  @@index([createdAt])
  @@map("clients")
}

model Permission {
  id              Int              @id @default(autoincrement())
  permissionName  String           @unique @map("permission_name")
  description     String?
  createdAt       DateTime         @default(now()) @map("created_at")
  rolePermissions RolePermission[]

  @@index([permissionName])
  @@map("permissions")
}

model Role {
  id              Int              @id @default(autoincrement())
  clientId        Int              @map("client_id")
  roleName        String           @map("role_name")
  description     String?
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @default(now()) @updatedAt @map("updated_at")
  rolePermissions RolePermission[]
  client          Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  users           User[]

  @@unique([clientId, roleName])
  @@index([clientId])
  @@index([roleName])
  @@index([createdAt])
  @@map("roles")
}

model User {
  id                   Int             @id @default(autoincrement())
  clientId             Int?            @map("client_id")
  email                String          @unique
  passwordHash         String          @map("password_hash")
  firstName            String?         @map("first_name")
  lastName             String?         @map("last_name")
  roleId               Int?            @map("role_id")
  isActive             Boolean         @default(true) @map("is_active")
  lastLogin            DateTime?       @map("last_login")
  passwordResetToken   String?         @map("password_reset_token")
  passwordResetExpires DateTime?       @map("password_reset_expires")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @default(now()) @updatedAt @map("updated_at")
  role                          Role?                 @relation(fields: [roleId], references: [id], onDelete: SetNull)
  client                        Client?               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  knowledgeBase                 KnowledgeBase[]
  ticketsCreated                Ticket[]              @relation("TicketCreator")
  ticketsAssigned               Ticket[]              @relation("TicketAssignee")
  changeRequestsCreated         TicketChangeRequest[] @relation("ChangeRequestedBy")
  changeRequestsReviewed        TicketChangeRequest[] @relation("ChangeReviewedBy")
  changeRequestsAssignedTo      TicketChangeRequest[] @relation("ChangeRequestedAssignee")
  departmentsResponsible        Department[]          @relation("DepartmentResponsible")

  @@index([email])
  @@index([clientId])
  @@index([roleId])
  @@index([isActive])
  @@index([lastLogin])
  @@index([passwordResetToken])
  @@index([createdAt])
  @@map("users")
}

model RolePermission {
  roleId       Int        @map("role_id")
  permissionId Int        @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model Report {
  id          Int      @id @default(autoincrement())
  clientId    Int      @map("client_id")
  name        String
  description String?
  type        String
  s3Key       String   @map("s3_key")
  s3Bucket    String   @map("s3_bucket")
  fileSize    Int?     @map("file_size")
  mimeType    String   @default("application/pdf") @map("mime_type")
  generatedAt DateTime @map("generated_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([type])
  @@index([generatedAt])
  @@index([createdAt])
  @@index([s3Key])
  @@map("reports")
}

model KnowledgeBase {
  id          Int      @id @default(autoincrement())
  clientId    Int?     @map("client_id")
  title       String
  content     String
  category    String
  tags        String?
  isPublic    Boolean  @default(false) @map("is_public")
  isActive    Boolean  @default(true) @map("is_active")
  authorId    Int?     @map("author_id")
  viewCount   Int      @default(0) @map("view_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  client      Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  author      User?    @relation(fields: [authorId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([authorId])
  @@index([category])
  @@index([isPublic])
  @@index([isActive])
  @@index([createdAt])
  @@index([title])
  @@map("knowledge_base")
}

model ClientFolderAccess {
  id          Int      @id @default(autoincrement())
  clientId    Int      @map("client_id")
  folderName  String   @map("folder_name")
  createdAt   DateTime @default(now()) @map("created_at")
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, folderName])
  @@index([clientId])
  @@index([folderName])
  @@map("client_folder_access")
}

model Invoice {
  id            Int      @id @default(autoincrement())
  clientId      Int      @map("client_id")
  invoiceNumber String   @unique @map("invoice_number")
  title         String
  description   String?
  amount        Float
  currency      String   @default("USD")
  status        String   @default("draft") // draft, sent, viewed, paid, overdue, cancelled
  dueDate       DateTime @map("due_date")
  issuedDate    DateTime @map("issued_date")
  paidDate      DateTime? @map("paid_date")
  s3Key         String?  @map("s3_key")
  s3Bucket      String?  @map("s3_bucket")
  fileSize      Int?     @map("file_size")
  mimeType      String?  @default("application/pdf") @map("mime_type")
  paymentLink   String?  @map("payment_link")
  paymentMethod String?  @map("payment_method")
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([status])
  @@index([dueDate])
  @@index([issuedDate])
  @@index([invoiceNumber])
  @@index([createdAt])
  @@map("invoices")
}

model Log {
  id          String   @id @default(uuid())
  timestamp   DateTime @default(now())
  userId      String   @map("user_id")
  eventType   String   @map("event_type") // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entity      String   // User, Role, Client, Invoice, etc.
  description String
  status      String   @default("SUCCESS") // SUCCESS, FAILURE, WARNING
  ipAddress   String?  @map("ip_address") // IP address from which the action was performed

  @@index([timestamp])
  @@index([userId])
  @@index([eventType])
  @@index([entity])
  @@index([status])
  @@index([ipAddress])
  @@map("logs")
}

model Department {
  id                Int                   @id @default(autoincrement())
  name              String                @unique // "Reporting", "Billing", "IT Support", "Operations"
  email             String                @unique // Contact email for the department
  responsibleUserId Int?                  @map("responsible_user_id")
  description       String?
  isActive          Boolean               @default(true) @map("is_active")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @default(now()) @updatedAt @map("updated_at")
  responsibleUser   User?                 @relation("DepartmentResponsible", fields: [responsibleUserId], references: [id], onDelete: SetNull)
  tickets           Ticket[]              @relation("TicketDepartment")
  changeRequests    TicketChangeRequest[] @relation("ChangeRequestedDepartment")

  @@index([name])
  @@index([responsibleUserId])
  @@index([isActive])
  @@map("departments")
}

model Ticket {
  id             String                @id @default(uuid())
  clientId       Int                   @map("client_id")
  userId         Int                   @map("user_id")
  assignedToId   Int?                  @map("assigned_to_id")
  departmentId   Int?                  @map("department_id")
  subject        String
  priority       String                // "High", "Medium", "Low"
  status         String                @default("Open") // "Open", "In Progress", "Resolved", "Closed"
  description    String                // JSON: { descriptionData, attachmentIds: [], url }
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @default(now()) @updatedAt @map("updated_at")
  client         Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user           User                  @relation("TicketCreator", fields: [userId], references: [id], onDelete: Cascade)
  assignedTo     User?                 @relation("TicketAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  department     Department?           @relation("TicketDepartment", fields: [departmentId], references: [id], onDelete: SetNull)
  details        TicketDetail[]
  attachments    TicketAttachment[]
  changeRequests TicketChangeRequest[]

  @@index([clientId])
  @@index([userId])
  @@index([assignedToId])
  @@index([departmentId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("tickets")
}

model TicketChangeRequest {
  id                      Int         @id @default(autoincrement())
  ticketId                String      @map("ticket_id")
  requestedById           Int         @map("requested_by_id")
  requestedStatus         String?     @map("requested_status")         // New status requested (null if no change)
  requestedPriority       String?     @map("requested_priority")       // New priority requested (null if no change)
  requestedAssignedToId   Int?        @map("requested_assigned_to_id") // New assignee requested (null if no change)
  requestedDepartmentId   Int?        @map("requested_department_id")  // New department requested (null if no change)
  currentStatus           String      @map("current_status")           // Status at time of request
  currentPriority         String      @map("current_priority")         // Priority at time of request
  currentAssignedToId     Int?        @map("current_assigned_to_id")   // Assignee at time of request
  currentDepartmentId     Int?        @map("current_department_id")    // Department at time of request
  status                  String      @default("pending")              // "pending", "approved", "rejected"
  reviewedById            Int?        @map("reviewed_by_id")
  reviewedAt              DateTime?   @map("reviewed_at")
  rejectionReason         String?     @map("rejection_reason")
  createdAt               DateTime    @default(now()) @map("created_at")
  updatedAt               DateTime    @default(now()) @updatedAt @map("updated_at")
  ticket                  Ticket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  requestedBy             User        @relation("ChangeRequestedBy", fields: [requestedById], references: [id], onDelete: Cascade)
  reviewedBy              User?       @relation("ChangeReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  requestedAssignedTo     User?       @relation("ChangeRequestedAssignee", fields: [requestedAssignedToId], references: [id], onDelete: SetNull)
  requestedDepartment     Department? @relation("ChangeRequestedDepartment", fields: [requestedDepartmentId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([requestedById])
  @@index([requestedDepartmentId])
  @@index([status])
  @@index([createdAt])
  @@map("ticket_change_requests")
}

model TicketDetail {
  id          Int                    @id @default(autoincrement())
  ticketId    String                 @map("ticket_id")
  detailData  String                 @map("detail_data")
  timestamp   DateTime               @default(now())
  ticket      Ticket                 @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  attachments TicketDetailAttachment[]

  @@index([ticketId])
  @@index([timestamp])
  @@map("ticket_details")
}

model TicketAttachment {
  id         Int      @id @default(autoincrement())
  ticketId   String   @map("ticket_id")
  fileName   String   @map("file_name")
  s3Key      String   @map("s3_key")
  s3Bucket   String   @map("s3_bucket")
  fileSize   Int?     @map("file_size")
  mimeType   String   @map("mime_type")
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([uploadedAt])
  @@map("ticket_attachments")
}

model TicketDetailAttachment {
  id             Int          @id @default(autoincrement())
  ticketDetailId Int          @map("ticket_detail_id")
  fileName       String       @map("file_name")
  s3Key          String       @map("s3_key")
  s3Bucket       String       @map("s3_bucket")
  fileSize       Int?         @map("file_size")
  mimeType       String       @map("mime_type")
  uploadedAt     DateTime     @default(now()) @map("uploaded_at")
  ticketDetail   TicketDetail @relation(fields: [ticketDetailId], references: [id], onDelete: Cascade)

  @@index([ticketDetailId])
  @@index([uploadedAt])
  @@map("ticket_detail_attachments")
}

model Announcement {
  id          String                     @id @default(uuid())
  title       String
  content     String                     // HTML content from TiptapEditor
  priority    String                     // "low", "medium", "high"
  createdAt   DateTime                   @default(now()) @map("created_at")
  updatedAt   DateTime                   @default(now()) @updatedAt @map("updated_at")
  recipients  AnnouncementRecipient[]
  attachments AnnouncementAttachment[]

  @@index([priority])
  @@index([createdAt])
  @@map("announcements")
}

model AnnouncementRecipient {
  id             Int          @id @default(autoincrement())
  announcementId String       @map("announcement_id")
  clientId       Int          @map("client_id")
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  client         Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([announcementId, clientId])
  @@index([announcementId])
  @@index([clientId])
  @@map("announcement_recipients")
}

model AnnouncementAttachment {
  id             Int          @id @default(autoincrement())
  announcementId String       @map("announcement_id")
  fileName       String       @map("file_name")
  s3Key          String       @map("s3_key")
  s3Bucket       String       @map("s3_bucket")
  fileSize       Int?         @map("file_size")
  mimeType       String       @map("mime_type")
  uploadedAt     DateTime     @default(now()) @map("uploaded_at")
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@index([announcementId])
  @@index([uploadedAt])
  @@map("announcement_attachments")
}
